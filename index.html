<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Card Wallet Ultra</title>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2/dist/quagga.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; text-align: center; padding: 20px; background: #f0f2f5; color: #1c1e21; margin: 0; }
        .container { max-width: 500px; margin: auto; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .logo { width: 60px; height: 60px; object-fit: contain; margin-bottom: 10px; border-radius: 8px; }
        #barcode { max-width: 100%; height: 100px; }
        button { background: #28a745; color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-size: 15px; width: 100%; margin-top: 8px; font-weight: bold; }
        .btn-blue { background: #007bff; }
        .btn-red { background: #dc3545; padding: 5px 10px; width: auto; font-size: 12px; }
        .btn-orange { background: #ff9800; }
        input { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        #scanner-container { width: 100%; height: 200px; border: 2px dashed #007bff; display: none; margin-bottom: 10px; border-radius: 10px; overflow: hidden; }
        video { width: 100%; height: 100%; object-fit: cover; }
        .card-item { display: flex; align-items: center; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee; text-align: left; }
        .card-item img { width: 40px; margin-right: 15px; }
    </style>
</head>
<body>

<div class="container">
    <h2>üìç Dichtstbijzijnde Kaart</h2>
    <div id="closest-card-area" class="card">
        <img id="main-logo" class="logo" src="https://via.placeholder.com/60?text=?" alt="logo">
        <h3 id="store-name" style="margin: 5px 0;">Zoeken...</h3>
        <svg id="barcode"></svg>
        <p id="distance" style="font-size: 0.8em; color: #777;"></p>
    </div>

    <hr>

    <h3>Nieuwe Kaart Toevoegen</h3>
    <div class="card">
        <input type="text" id="newName" placeholder="Winkelnaam (bijv. Albert Heijn)">
        <input type="text" id="newWebsite" placeholder="Website (bijv. ah.nl voor logo)">
        <input type="text" id="newCode" placeholder="Barcodenummer">
        
        <div id="scanner-container"></div>
        <button type="button" class="btn-blue" onclick="startScanner()">üì∑ Scan Barcode</button>
        <button onclick="saveCard()">üíæ Opslaan op huidige locatie</button>
    </div>

    <h3>Mijn Kaartenlijst</h3>
    <div id="card-list" class="card">
        </div>

    <div class="card" style="background: #eee;">
        <h4>Beheer</h4>
        <button class="btn-orange" onclick="downloadBackup()">üì§ Download Backup</button>
        <input type="file" id="importFile" accept=".json" onchange="importBackup(event)" style="margin-top:10px; font-size: 12px;">
    </div>
</div>

<script>
    let cards = JSON.parse(localStorage.getItem('myCards')) || [];

    function startScanner() {
        const container = document.getElementById('scanner-container');
        container.style.display = 'block';
        Quagga.init({
            inputStream: { name: "Live", type: "LiveStream", target: container, constraints: { facingMode: "environment" } },
            decoder: { readers: ["ean_reader", "code_128_reader"] }
        }, (err) => {
            if (err) return alert("Camerafout");
            Quagga.start();
        });
        Quagga.onDetected(data => {
            document.getElementById('newCode').value = data.codeResult.code;
            Quagga.stop();
            container.style.display = 'none';
        });
    }

    function saveCard() {
        const name = document.getElementById('newName').value;
        const website = document.getElementById('newWebsite').value;
        const code = document.getElementById('newCode').value;
        if (!name || !code) return alert("Naam en code zijn verplicht");

        navigator.geolocation.getCurrentPosition(pos => {
            const logo = website ? `https://logo.clearbit.com/${website}` : `https://ui-avatars.com/api/?name=${name}`;
            cards.push({ name, code, logo, lat: pos.coords.latitude, lon: pos.coords.longitude });
            localStorage.setItem('myCards', JSON.stringify(cards));
            location.reload();
        });
    }

    function renderList() {
        const listDiv = document.getElementById('card-list');
        if (cards.length === 0) { listDiv.innerHTML = "Nog geen kaarten."; return; }
        listDiv.innerHTML = cards.map((c, index) => `
            <div class="card-item">
                <div style="display:flex; align-items:center;">
                    <img src="${c.logo}" onerror="this.src='https://via.placeholder.com/40'">
                    <span><b>${c.name}</b><br><small>${c.code}</small></span>
                </div>
                <button class="btn-red" onclick="deleteCard(${index})">Wis</button>
            </div>
        `).join('');
    }

    function deleteCard(index) {
        if (confirm("Kaart verwijderen?")) {
            cards.splice(index, 1);
            localStorage.setItem('myCards', JSON.stringify(cards));
            location.reload();
        }
    }

    function findClosest() {
        if (navigator.geolocation && cards.length > 0) {
            navigator.geolocation.getCurrentPosition(pos => {
                let closest = null, minD = Infinity;
                cards.forEach(c => {
                    const d = getDistance(pos.coords.latitude, pos.coords.longitude, c.lat, c.lon);
                    if (d < minD) { minD = d; closest = c; }
                });
                if (closest) {
                    document.getElementById('store-name').innerText = closest.name;
                    document.getElementById('main-logo').src = closest.logo;
                    document.getElementById('distance').innerText = `Afstand: ${Math.round(minD)} meter`;
                    JsBarcode("#barcode", closest.code);
                }
            });
        }
    }

    function getDistance(lat1, lon1, lat2, lon2) {
        const R = 6371e3;
        const a = Math.sin(((lat2-lat1)*Math.PI/180)/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(((lon2-lon1)*Math.PI/180)/2)**2;
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    function downloadBackup() {
        const blob = new Blob([JSON.stringify(cards)], {type: "application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = "kaarten_backup.json";
        a.click();
    }

    function importBackup(e) {
        const reader = new FileReader();
        reader.onload = (ev) => {
            cards = JSON.parse(ev.target.result);
            localStorage.setItem('myCards', JSON.stringify(cards));
            location.reload();
        };
        reader.readAsText(e.target.files[0]);
    }

    renderList();
    findClosest();
</script>
</body>
</html>
