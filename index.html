<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Card Wallet Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2/dist/quagga.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; text-align: center; padding: 20px; background: #f0f2f5; color: #1c1e21; margin: 0; }
        .container { max-width: 500px; margin: auto; padding-bottom: 50px; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .logo-container { width: 50px; height: 50px; min-width: 50px; margin-right: 15px; display: flex; align-items: center; justify-content: center; border-radius: 8px; background: #007bff; overflow: hidden; font-weight: bold; color: white; }
        .logo-img { width: 100%; height: 100%; object-fit: contain; }
        #barcode { max-width: 100%; height: 100px; }
        button { background: #28a745; color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: bold; margin-top: 5px; }
        .btn-blue { background: #007bff; }
        .btn-orange { background: #fd7e14; }
        .btn-red { background: #dc3545; }
        .btn-small { padding: 5px 10px; width: auto; font-size: 11px; }
        input { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .card-item { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #eee; text-align: left; }
        
        /* Modal (Bewerk-venster) */
        #editModal { display:none; position:fixed; z-index:100; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.6); align-items:center; justify-content:center; }
        .modal-content { background:white; padding:20px; border-radius:15px; width:90%; max-width:400px; }
    </style>
</head>
<body>

<div class="container">
    <h2>üìç Slimme Kaarthouder</h2>
    
    <div id="closest-area" class="card">
        <div id="main-logo-box" style="display:flex; justify-content:center; margin-bottom:10px;"></div>
        <h3 id="store-name" style="margin:5px 0;">Geen kaarten</h3>
        <svg id="barcode"></svg>
        <p id="distance" style="font-size:0.8em; color:#777;"></p>
    </div>

    <div class="card">
        <button class="btn-blue" onclick="toggleAdd()">‚ûï Nieuwe Kaart Toevoegen</button>
        <div id="addForm" style="display:none; margin-top:15px;">
            <input type="text" id="newName" placeholder="Winkelnaam">
            <input type="text" id="newCode" placeholder="Barcodenummer">
            <button class="btn-orange" onclick="startScanner()">üì∑ Scan Barcode</button>
            <button onclick="saveCard(true)">üíæ Opslaan MET huidige locatie</button>
            <button class="btn-blue" onclick="saveCard(false)">üíæ Alleen opslaan (geen locatie)</button>
        </div>
    </div>

    <h3>Mijn Lijst</h3>
    <div id="card-list" class="card"></div>

    <button class="btn-orange" style="width:auto;" onclick="downloadBackup()">üì§ Backup</button>
</div>

<div id="editModal">
    <div class="modal-content">
        <h3>Kaart Bewerken</h3>
        <input type="text" id="editName" placeholder="Winkelnaam">
        <input type="text" id="editWebsite" placeholder="Website (voor logo, bijv. ah.nl)">
        <input type="text" id="editCode" placeholder="Barcodenummer">
        <p id="loc-status" style="font-size:0.8em;"></p>
        <button class="btn-orange" onclick="updateLocForEdit()">üìç Gebruik mijn huidige locatie</button>
        <button onclick="confirmEdit()">Klaar</button>
        <button class="btn-red" onclick="closeEdit()">Annuleren</button>
    </div>
</div>

<script>
    let cards = JSON.parse(localStorage.getItem('myCards')) || [];
    let currentEditIndex = null;

    function getLogoHtml(card, size = 40) {
        const letter = card.name ? card.name.charAt(0).toUpperCase() : '?';
        const logoUrl = card.logo || '';
        return `
            <div class="logo-container" style="width:${size}px; height:${size}px;">
                <img src="${logoUrl}" class="logo-img" onerror="this.style.display='none'; this.parentElement.innerHTML='${letter}';" alt="">
            </div>`;
    }

    function saveCard(withLoc) {
        const name = document.getElementById('newName').value;
        const code = document.getElementById('newCode').value;
        if (!name || !code) return alert("Vul naam en code in");

        const newCard = { name, code, logo: '', lat: null, lon: null };

        if (withLoc) {
            navigator.geolocation.getCurrentPosition(pos => {
                newCard.lat = pos.coords.latitude;
                newCard.lon = pos.coords.longitude;
                finalizeSave(newCard);
            }, () => { alert("Locatie mislukt, kaart opgeslagen zonder locatie."); finalizeSave(newCard); });
        } else {
            finalizeSave(newCard);
        }
    }

    function finalizeSave(card) {
        cards.push(card);
        localStorage.setItem('myCards', JSON.stringify(cards));
        location.reload();
    }

    function renderList() {
        const listDiv = document.getElementById('card-list');
        listDiv.innerHTML = cards.map((c, i) => `
            <div class="card-item">
                ${getLogoHtml(c)}
                <div style="flex-grow:1">
                    <b>${c.name}</b><br><small>${c.lat ? 'üìç Locatie ingesteld' : '‚ö™ Geen locatie'}</small>
                </div>
                <button class="btn-blue btn-small" onclick="openEdit(${i})">Edit</button>
                <button class="btn-red btn-small" onclick="deleteCard(${i})">X</button>
            </div>
        `).join('');
    }

    function openEdit(index) {
        currentEditIndex = index;
        const c = cards[index];
        document.getElementById('editName').value = c.name;
        document.getElementById('editCode').value = c.code;
        document.getElementById('editWebsite').value = c.website || '';
        document.getElementById('loc-status').innerText = c.lat ? "Locatie is al bekend." : "Nog geen locatie gekoppeld.";
        document.getElementById('editModal').style.display = 'flex';
    }

    function updateLocForEdit() {
        navigator.geolocation.getCurrentPosition(pos => {
            cards[currentEditIndex].lat = pos.coords.latitude;
            cards[currentEditIndex].lon = pos.coords.longitude;
            document.getElementById('loc-status').innerText = "üìç Locatie NU vastgelegd!";
        });
    }

    function confirmEdit() {
        const c = cards[currentEditIndex];
        c.name = document.getElementById('editName').value;
        c.code = document.getElementById('editCode').value;
        const web = document.getElementById('editWebsite').value;
        c.website = web;
        if(web) c.logo = `https://logo.clearbit.com/${web}`;
        
        localStorage.setItem('myCards', JSON.stringify(cards));
        location.reload();
    }

    function findClosest() {
        if (navigator.geolocation && cards.length > 0) {
            navigator.geolocation.getCurrentPosition(pos => {
                let closest = null, minD = Infinity;
                cards.forEach(c => {
                    if (c.lat && c.lon) {
                        const d = getDistance(pos.coords.latitude, pos.coords.longitude, c.lat, c.lon);
                        if (d < minD) { minD = d; closest = c; }
                    }
                });
                if (closest) {
                    document.getElementById('store-name').innerText = closest.name;
                    document.getElementById('main-logo-box').innerHTML = getLogoHtml(closest, 60);
                    document.getElementById('distance').innerText = `Afstand: ${Math.round(minD)} meter`;
                    JsBarcode("#barcode", closest.code);
                }
            });
        }
    }

    // Helper functies
    function toggleAdd() { const f = document.getElementById('addForm'); f.style.display = f.style.display === 'none' ? 'block' : 'none'; }
    function closeEdit() { document.getElementById('editModal').style.display = 'none'; }
    function deleteCard(i) { if(confirm("Wissen?")) { cards.splice(i,1); localStorage.setItem('myCards', JSON.stringify(cards)); renderList(); } }
    function getDistance(lat1, lon1, lat2, lon2) {
        const R = 6371e3;
        const a = Math.sin(((lat2-lat1)*Math.PI/180)/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(((lon2-lon1)*Math.PI/180)/2)**2;
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }
    function downloadBackup() {
        const a = document.createElement('a');
        a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(cards));
        a.download = "kaarten.json"; a.click();
    }

    renderList();
    findClosest();
</script>
</body>
</html>
