<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Card Wallet Ultra</title>
    
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2/dist/quagga.min.js"></script>

    <script>
        // GLOBALE VARIABELE EN FUNCTIES
        let cards = JSON.parse(localStorage.getItem('myCards')) || [];
        let currentEditIndex = null;
        let tempBase64 = null;

        function toggleAdd() {
            const f = document.getElementById('addForm');
            if (f) {
                f.style.display = (f.style.display === 'none' || f.style.display === '') ? 'block' : 'none';
            }
        }

        function getLogoHtml(card, size = 50) {
            const letter = card.name ? card.name.charAt(0).toUpperCase() : '?';
            const bgColor = card.color || '#007bff';
            return `<div class="logo-container ${card.logo ? 'has-logo' : ''}" style="width:${size}px; height:${size}px; min-width:${size}px; background-color:${bgColor};">
                ${card.logo ? `<img src="${card.logo}" class="logo-img" onerror="this.style.display='none'; this.parentElement.classList.remove('has-logo'); this.parentElement.innerHTML='${letter}';">` : letter}
            </div>`;
        }

        function saveCard() {
            const name = document.getElementById('newName').value;
            const code = document.getElementById('newCode').value;
            if (!name || !code) return alert("Vul naam en code in");
            cards.push({ name, code, logo: '', color: '#007bff', lat: null, lon: null });
            localStorage.setItem('myCards', JSON.stringify(cards));
            window.location.reload();
        }

        function showCard(index) {
            const c = cards[index];
            if(!c) return;
            document.getElementById('store-name').innerText = c.name;
            document.getElementById('main-logo-box').innerHTML = getLogoHtml(c, 70);
            document.getElementById('distance').innerText = "Geselecteerd";
            JsBarcode("#barcode", c.code, { width: 2, height: 100, displayValue: true });
            window.scrollTo({top: 0, behavior: 'smooth'});
        }

        function openEdit(index, event) {
            if (event) event.stopPropagation();
            currentEditIndex = index;
            const c = cards[index];
            document.getElementById('editName').value = c.name;
            document.getElementById('editCode').value = c.code;
            document.getElementById('editDomain').value = c.domain || '';
            document.getElementById('editLogoUrl').value = (c.logo && !c.logo.startsWith('data:')) ? c.logo : '';
            document.getElementById('editColor').value = c.color || '#007bff';
            document.getElementById('editModal').style.display = 'flex';
        }

        function confirmEdit() {
            const c = cards[currentEditIndex];
            c.name = document.getElementById('editName').value;
            c.code = document.getElementById('editCode').value;
            c.color = document.getElementById('editColor').value;
            const dom = document.getElementById('editDomain').value;
            const url = document.getElementById('editLogoUrl').value;
            c.domain = dom;
            if (tempBase64) c.logo = tempBase64;
            else if (url) c.logo = url;
            else if (dom) c.logo = `https://www.google.com/s2/favicons?sz=128&domain=${dom}`;
            localStorage.setItem('myCards', JSON.stringify(cards));
            window.location.reload();
        }

        function deleteCard(index, event) {
            if (event) event.stopPropagation();
            if(confirm("Deze kaart verwijderen?")) {
                cards.splice(index, 1);
                localStorage.setItem('myCards', JSON.stringify(cards));
                renderList();
            }
        }

        function updateLocForEdit() {
            navigator.geolocation.getCurrentPosition(pos => {
                cards[currentEditIndex].lat = pos.coords.latitude;
                cards[currentEditIndex].lon = pos.coords.longitude;
                alert("Locatie van deze winkel is nu vastgelegd!");
            });
        }

        function renderList() {
            const listDiv = document.getElementById('card-list');
            if (!listDiv) return;
            listDiv.innerHTML = cards.map((c, i) => `
                <div class="card-item" onclick="showCard(${i})">
                    ${getLogoHtml(c, 45)}
                    <div style="flex-grow:1; margin-left:10px;"><b>${c.name}</b><br><small>${c.lat ? 'üìç Locatie aan' : '‚ö™ Geen locatie'}</small></div>
                    <button class="btn-blue btn-small" onclick="openEdit(${i}, event)">Edit</button>
                    <button class="btn-red btn-small" onclick="deleteCard(${i}, event)">X</button>
                </div>`).join('') || "Geen kaarten gevonden.";
        }

        function startScanner() {
            const f = document.createElement('div');
            f.style = "position:fixed;top:0;left:0;width:100%;height:100%;background:black;z-index:2000;";
            document.body.appendChild(f);
            Quagga.init({
                inputStream: { name: "Live", type: "LiveStream", target: f, constraints: { facingMode: "environment" } },
                decoder: { readers: ["ean_reader", "code_128_reader"] }
            }, (err) => {
                if (err) { alert("Camerafout: " + err); f.remove(); return; }
                Quagga.start();
            });
            Quagga.onDetected(d => {
                document.getElementById('newCode').value = d.codeResult.code;
                Quagga.stop();
                f.remove();
            });
            f.onclick = () => { Quagga.stop(); f.remove(); };
        }

        function handleFileUpload(e) {
            const file = e.target.files[0];
            const r = new FileReader();
            r.onload = (ev) => { tempBase64 = ev.target.result; };
            r.readAsDataURL(file);
        }

        function downloadBackup() {
            const a = document.createElement('a');
            a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(cards));
            a.download = "backup.json";
            a.click();
        }

        function importBackup(e) {
            const r = new FileReader();
            r.onload = (ev) => {
                cards = JSON.parse(ev.target.result);
                localStorage.setItem('myCards', JSON.stringify(cards));
                window.location.reload();
            };
            r.readAsText(e.target.files[0]);
        }

        function closeEdit() { document.getElementById('editModal').style.display = 'none'; }

        // Initialisatie bij het laden van de pagina
        window.onload = function() {
            renderList();
            if (navigator.geolocation && cards.length > 0) {
                navigator.geolocation.getCurrentPosition(pos => {
                    let closestIdx = -1, minD = Infinity;
                    cards.forEach((c, i) => {
                        if (c.lat) {
                            const R = 6371e3;
                            const dLat = (c.lat - pos.coords.latitude) * Math.PI / 180;
                            const dLon = (c.lon - pos.coords.longitude) * Math.PI / 180;
                            const a = Math.sin(dLat/2)**2 + Math.cos(pos.coords.latitude*Math.PI/180)*Math.cos(c.lat*Math.PI/180)*Math.sin(dLon/2)**2;
                            const d = R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                            if (d < minD) { minD = d; closestIdx = i; }
                        }
                    });
                    if (closestIdx !== -1 && minD < 500) {
                        showCard(closestIdx);
                        document.getElementById('distance').innerText = `Afstand: ${Math.round(minD)}m`;
                    }
                });
            }
        };
    </script>

    <style>
        :root { --primary: #007bff; --success: #28a745; --danger: #dc3545; --warning: #fd7e14; }
        body { font-family: 'Segoe UI', sans-serif; text-align: center; padding: 0; margin: 0; background: #f0f2f5; color: #1c1e21; }
        .container { max-width: 500px; margin: auto; padding: 20px; padding-bottom: 80px; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 20px; }
        .logo-container { width: 60px; height: 60px; min-width: 60px; margin: 0 auto 10px; display: flex; align-items: center; justify-content: center; border-radius: 50%; overflow: hidden; font-weight: bold; color: white; border: 1px solid #eee; background: var(--primary); }
        .logo-img { width: 85%; height: 85%; object-fit: contain; }
        .has-logo { background: white !important; }
        #barcode-wrapper { background: white; padding: 10px; border-radius: 10px; display: inline-block; margin-top: 10px; width: 100%; box-sizing: border-box; min-height: 120px; }
        #barcode { max-width: 100%; height: auto; }
        button { background: var(--success); color: white; border: none; padding: 12px; border-radius: 10px; cursor: pointer; font-size: 15px; font-weight: bold; width: 100%; margin-top: 10px; }
        .btn-blue { background: var(--primary); }
        .btn-orange { background: var(--warning); }
        .btn-red { background: var(--danger); }
        .btn-small { padding: 6px 12px; width: auto; font-size: 12px; margin: 2px; }
        input { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; }
        label { display: block; text-align: left; font-size: 11px; font-weight: bold; margin-bottom: 3px; color: #666; text-transform: uppercase; }
        .card-item { display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #f0f0f0; text-align: left; cursor: pointer; }
        #editModal { display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.8); align-items:center; justify-content:center; }
        .modal-content { background:white; padding:25px; border-radius:20px; width:90%; max-width:400px; text-align: left; max-height: 90vh; overflow-y: auto; }
    </style>
</head>
<body>

<div class="container">
    <h2 style="margin-top: 10px;">üìç Slimme Kaarthouder</h2>
    
    <div id="closest-area" class="card">
        <div id="main-logo-box"></div>
        <h3 id="store-name" style="margin: 5px 0;">Geen kaart geselecteerd</h3>
        <div id="barcode-wrapper"><svg id="barcode"></svg></div>
        <p id="distance" style="font-size: 0.85em; color: #666; margin-top: 10px;"></p>
    </div>

    <div class="card">
        <button class="btn-blue" onclick="toggleAdd()">‚ûï Nieuwe Kaart Toevoegen</button>
        <div id="addForm" style="display:none; margin-top:20px; text-align: left;">
            <label>Winkelnaam</label><input type="text" id="newName" placeholder="Bijv. Jumbo">
            <label>Barcodenummer</label><input type="text" id="newCode" placeholder="Typ nummer of scan">
            <button class="btn-orange" onclick="startScanner()">üì∑ Scan Barcode</button>
            <button onclick="saveCard()">üíæ Kaart Opslaan</button>
        </div>
    </div>

    <h3>Mijn Kaarten</h3>
    <div id="card-list" class="card" style="padding: 5px;"></div>

    <div style="display: flex; gap: 10px;">
        <button class="btn-orange" onclick="downloadBackup()">üì§ Backup</button>
        <button class="btn-blue" style="position: relative; overflow: hidden;">üì• Import 
            <input type="file" accept=".json" onchange="importBackup(event)" style="position:absolute; opacity:0; left:0; top:0; height:100%; width:100%; cursor:pointer;">
        </button>
    </div>
</div>

<div id="editModal">
    <div class="modal-content">
        <h3>Aanpassen</h3>
        <label>Winkelnaam</label><input type="text" id="editName">
        <label>Barcodenummer</label><input type="text" id="editCode">
        <hr>
        <label>Domein (jumbo.com)</label><input type="text" id="editDomain">
        <label>Logo URL</label><input type="text" id="editLogoUrl">
        <label>Eigen foto</label><input type="file" id="editLogoFile" accept="image/*" onchange="handleFileUpload(event)">
        <hr>
        <label>Kleur</label><input type="color" id="editColor" style="height:40px;">
        <button class="btn-orange" onclick="updateLocForEdit()">üìç Locatie Nu Vastleggen</button>
        <button onclick="confirmEdit()" style="margin-top:15px;">üíæ Opslaan</button>
        <button class="btn-red" onclick="closeEdit()">Annuleren</button>
    </div>
</div>

</body>
</html>
